<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>血壓紀錄 Blood Pressure Logger (Cloud)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111;
    }
    .app {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 16px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 16px;
      margin-bottom: 16px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    button {
      background: #007aff;
      color: white;
      font-weight: bold;
      border: none;
      padding: 8px 12px;
    }
    button.secondary { background: #eee; color: #333; }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .small { font-size: 0.8rem; color: #666; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { padding: 4px 6px; border-bottom: 1px solid #ddd; white-space: nowrap; }
    .tag { padding: 1px 6px; border-radius: 999px; background: #eee; font-size: 0.75rem; }
    .tag.sysdia { background: #e0f0ff; }
    .tag.hr { background: #ffe0e0; }
    canvas { max-height: 260px; }
  </style>
</head>

<body>
  <div class="app">
    <h1>血壓紀錄（Google Sheet 雲端同步版）</h1>
    <div class="subtitle">電腦輸入、手機查看，用同一個網址即可同步。</div>

    <!-- 表單 -->
    <div class="card">
      <h2>新增紀錄 Add Record</h2>
      <div class="form-grid">
        <label>日期 <input type="date" id="dateInput"></label>
        <label>時間 <input type="time" id="timeInput"></label>
        <label>收縮壓 <input type="number" id="sysInput"></label>
        <label>舒張壓 <input type="number" id="diaInput"></label>
        <label>心跳 <input type="number" id="hrInput"></label>
        <label>姿勢
          <select id="postureInput">
            <option value="">未填寫</option>
            <option>坐姿</option><option>站姿</option><option>躺姿</option>
          </select>
        </label>
        <label>手臂
          <select id="armInput">
            <option value="">未填寫</option>
            <option>左手</option><option>右手</option>
          </select>
        </label>
        <label>備註 <textarea id="noteInput"></textarea></label>
      </div>
      <div class="actions">
        <button id="saveBtn">儲存 Save</button>
        <button class="secondary" id="nowBtn">現在時間</button>
        <button class="secondary" id="clearFormBtn">清空</button>
      </div>
      <div id="message" class="small"></div>
    </div>

    <!-- 統計 -->
    <div class="card">
      <h2>統計與趨勢</h2>
      <div id="stats" class="small">讀取中…</div>
      <canvas id="bpChart"></canvas>
    </div>

    <!-- 表格 -->
    <div class="card">
      <h2>歷史紀錄</h2>
      <table>
        <thead><tr>
          <th>日期</th><th>時間</th><th>血壓</th><th>心跳</th><th>姿勢/手臂</th><th>備註</th>
        </tr></thead>
        <tbody id="recordsBody"></tbody>
      </table>
      <div id="recordCount" class="small"></div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("dateInput");
  const timeInput = document.getElementById("timeInput");
  const sysInput  = document.getElementById("sysInput");
  const diaInput  = document.getElementById("diaInput");
  const hrInput   = document.getElementById("hrInput");
  const postureInput = document.getElementById("postureInput");
  const armInput  = document.getElementById("armInput");
  const noteInput = document.getElementById("noteInput");
  const msg = document.getElementById("message");
  const statsEl = document.getElementById("stats");
  const recordsBody = document.getElementById("recordsBody");
  const recordCount = document.getElementById("recordCount");

  let chart = null;
  let records = [];

  function setNow() {
    const t = new Date();
    dateInput.value = t.toISOString().slice(0,10);
    timeInput.value = t.toTimeString().slice(0,5);
  }
  setNow();

  // 取得資料（Apps Script API）
  function loadRecords() {
    statsEl.textContent = "讀取中…";
    google.script.run
      .withSuccessHandler(arr => {
        records = arr;
        renderEverything();
      })
      .getRecords();
  }

  // 表格、統計、圖
  function renderEverything() {
    renderTable();
    renderStats();
    renderChart();
  }

  function renderTable() {
    recordsBody.innerHTML = "";
    records.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td><span class="tag sysdia">${r.systolic}/${r.diastolic}</span></td>
        <td><span class="tag hr">${r.heartRate || '-'}</span></td>
        <td>${(r.posture||'') + ' ' + (r.arm||'')}</td>
        <td>${r.note||''}</td>`;
      recordsBody.appendChild(tr);
    });
    recordCount.textContent = `共 ${records.length} 筆`;
  }

  function renderStats() {
    if (!records.length) {
      statsEl.textContent = "尚無資料";
      return;
    }
    const now = new Date();
    const seven = now.getTime() - 6*86400*1000;
    const recent = records.filter(r => {
      return new Date(r.date).getTime() >= seven;
    });
    if (!recent.length) {
      statsEl.textContent = "最近 7 天無紀錄";
      return;
    }
    const avgSys = recent.reduce((s,r)=>s+r.systolic,0)/recent.length;
    const avgDia = recent.reduce((s,r)=>s+r.diastolic,0)/recent.length;
    statsEl.textContent = `最近 7 天平均：約 ${avgSys.toFixed(1)} / ${avgDia.toFixed(1)} mmHg`;
  }

  function renderChart() {
    if (chart) chart.destroy();
    if (!records.length) return;

    const labels = records.map(r => `${r.date} ${r.time}`);
    const sys = records.map(r => r.systolic);
    const dia = records.map(r => r.diastolic);

    chart = new Chart(document.getElementById("bpChart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label:"收縮壓", data:sys, borderColor:"red" },
          { label:"舒張壓", data:dia, borderColor:"blue" }
        ]
      },
      options:{ responsive:true }
    });
  }

  // 儲存
  document.getElementById("saveBtn").onclick = () => {
    const data = {
      date: dateInput.value,
      time: timeInput.value,
      systolic: Number(sysInput.value),
      diastolic: Number(diaInput.value),
      heartRate: hrInput.value ? Number(hrInput.value):"",
      posture: postureInput.value,
      arm: armInput.value,
      note: noteInput.value
    };
    msg.textContent = "儲存中…";

    google.script.run
      .withSuccessHandler(res => {
        msg.textContent = "已儲存！";
        loadRecords();
      })
      .addRecord(data);
  };

  document.getElementById("nowBtn").onclick = setNow;
  document.getElementById("clearFormBtn").onclick = () => {
    sysInput.value = "";
    diaInput.value = "";
    hrInput.value = "";
    postureInput.value = "";
    armInput.value = "";
    noteInput.value = "";
    msg.textContent = "";
  };

  // 初始化
  loadRecords();
});
</script>

</body>
</html>
